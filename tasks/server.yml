---
- name: Install server packages
  yum: name=samba state=present

- name: Configure smb
  template: dest=/etc/samba/smb.conf src=smb.conf.j2 validate='testparm -s %s' owner=root group=root mode=0644

- name: Enable and start server
  service: name=smb state=started enabled=yes

- name: Find current list of samba users
  shell: 'pdbedit -L | cut -d : -f 1'
  register: samba__r_current_users
  changed_when: no
  checked_mode: no

- name: Delete rogue samba users
  command: pdbedit -x {{item}}
  with_items: '{{samba__r_current_users.stdout_lines}}'
  when: item not in samba_users | map(attribute="user") | list

- name: Add samba users
  shell: (echo "{{item.password}}"; echo "{{item.password}}")  | smbpasswd -s -a {{item.user}}
  with_items: '{{samba_users}}'
  when: item.user not in samba__r_current_users.stdout_lines
  # TODO: change password
